Follow these steps to install the agent

1. Create IAM role
Navigate to IAM Roles -> select 'AWS service' trusted entity type -> select EC2 use case -> Next
2. Attach permission policy to the role
Search for 'CloudWatchAgent' in permissions policies 
-> select 'CloudWatchAgentServerPolicy' and 'CloudWatchAgentAdminPolicy' -> Next
* 'CloudWatchAgentAdminPolicy' is only needed for installation permissions.
3. Assign a role name then create

2. Create EC2 instance
EC2 - launch instance
Select pre-defined security group
Allow SSH traffic from 'Anywhere' - to SSH connection to the instance for testing later
Allow HTTP traffic from the internet - for testing later
Attach the IAM role created in step 1
Launch instance

Once the instance is launched, connect to it via 'instance connect'
* We are going to run a webserver for testing
`sudo su` - elevate priviledge so we could execute installations
`yum install httpd`
`echo "This is a sample file" > /var/www/html/index.html  - create a sample file in web default dir
`sudo systemctl start httpd`  - to start the webserver
`sudo systemctl enable httpd`  - to allow for service restart
Verify the sample file created exists via opening the instance IP on the  browser. Opening this will generate log entries

Access the logs generated by the webserver in the following:
`cat /var/log/httpd/access_log`  - all access logs
`cat /var/log/httpd/error_log    - all error logs



3. Install the agent to collect metric logs
Install the agent on Amazon Linux 2
`sudo yum install amazon-cloudwatch-agent`

# configure the agent by following the wizard
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
* follow the prompts
* just choose the defaults except for CollectD(choose 2)
* specify the dir of logs
    - /var/log/httpd/access_log
    - /var/log/httpd/error_log
* choose option to store config in SSM Paramter Store


# If you chose to use CollectD from the wizard option, create the required files
sudo mkdir -p /usr/share/collectd
sudo touch /usr/share/collectd/types.db

# restart the instance options
- if using SSM parameter store
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c ssm:AmazonCloudWatch-linux -s
- if not using SSM parameter store, specify the config file
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s


4. Verify logs are being ingested by Cloudwatch
Navigate to Cloudwatch -> Metrics -> CWAgent namespace is create